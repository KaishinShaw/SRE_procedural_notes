## Docker容器停止方式对比

在Docker中，于容器内执行`shutdown`命令和在宿主机执行`docker stop`有显著区别，主要体现在**进程终止机制、信号处理、权限控制及资源释放**等方面。

------------------------------------------------------------------------

### 1. **进程终止机制**

-   **容器内执行 `shutdown`:**
    -   `shutdown`是系统级命令，旨在关闭完整的操作系统。但在容器中（通常仅包含单个进程或少量服务），它可能无法正常工作。
    -   若容器以`PID 1`进程运行（如直接运行应用），执行`shutdown`可能导致容器直接退出，但**可能绕过Docker的停止流程**，导致资源未被正确清理。
    -   若容器内安装了`init`系统（如`systemd`），`shutdown`会尝试停止所有服务，但容器环境通常不完整，可能引发错误或阻塞。
-   **宿主机执行 `docker stop`:**
    -   Docker会先向容器主进程发送**SIGTERM**信号，允许进程进行优雅退出（如保存状态、释放资源）。
    -   若容器在默认10秒内未停止，Docker会强制发送**SIGKILL**终止进程。此过程由Docker管控，确保资源释放和状态更新。

------------------------------------------------------------------------

### 2. **信号处理**

-   **`shutdown`命令：**
    -   触发内核的关机流程，可能向容器内所有进程广播信号，但容器受限于隔离性，可能无法正确处理。
    -   若容器主进程（PID 1）未捕获`SIGTERM`或`SIGINT`，可能导致进程被强制终止，无法优雅退出。
-   **`docker stop`命令：**
    -   直接针对容器主进程发送`SIGTERM`，允许进程自定义信号处理逻辑（如Java应用注册Shutdown Hook）。
    -   支持通过`--time`参数调整等待时间（如`docker stop --time=20 <容器>`），灵活性更高。

------------------------------------------------------------------------

### 3. **权限与隔离性**

-   **容器内执行 `shutdown`:**
    -   需要容器具有**特权模式**（`--privileged`）或`CAP_SYS_BOOT`能力，否则权限不足，命令无法执行。
    -   普通容器默认无此权限，执行会报错：`shutdown: Unable to shutdown system`。
-   **`docker stop`命令：**
    -   仅需宿主机用户有Docker操作权限（如属于`docker`用户组），与容器内部权限无关。

------------------------------------------------------------------------

### 4. **资源释放与状态管理**

-   **`shutdown`命令：**
    -   容器可能异常退出，Docker可能无法正确标记容器状态（如残留`Exited (137)`），需手动清理。
    -   挂载的卷、网络端口等资源可能未正确释放，导致后续启动冲突。
-   **`docker stop`命令：**
    -   Docker自动更新容器状态为`Exited (0)`或其他退出码，并释放关联资源（网络端口、存储卷等）。
    -   日志和事件可通过`docker logs`或`docker inspect`查看，便于故障排查。

------------------------------------------------------------------------

### 示例场景

1.  **容器内执行 `shutdown -h now`:**

    ``` bash
    # 进入容器
    docker exec -it my_container bash
    # 尝试关机（通常失败）
    shutdown -h now
    # 输出：shutdown: Unable to shutdown system
    ```

2.  **宿主机执行 `docker stop`:**

    ``` bash
    # 优雅停止容器，超时时间调整为20秒
    docker stop --time=20 my_container
    ```

------------------------------------------------------------------------

### 总结

| **对比项**   | **容器内 `shutdown`**              | **宿主机 `docker stop`**          |
|--------------|------------------------------------|-----------------------------------|
| **信号控制** | 可能无法正确处理信号               | 发送SIGTERM/SIGKILL，确保优雅终止 |
| **权限要求** | 需特权或CAP_SYS_BOOT               | 仅需Docker命令权限                |
| **资源释放** | 可能泄漏资源                       | 自动释放资源并更新状态            |
| **适用场景** | 不推荐，除非明确需要系统级关机操作 | 标准且安全的容器停止方式          |

**结论：** 始终优先使用`docker stop`停止容器，避免直接运行`shutdown`，以确保符合Docker生命周期管理机制。
