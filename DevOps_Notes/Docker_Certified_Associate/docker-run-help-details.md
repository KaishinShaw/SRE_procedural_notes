## `docker run --help` 命令详解

------------------------------------------------------------------------

### 命令用法

``` bash
Usage: docker run [OPTIONS] IMAGE [COMMAND] [ARG...]
```

**翻译**：\
`docker run [选项] 镜像 [命令] [参数...]`\
**解释**：\
从指定镜像创建并启动一个新容器。可选的 `COMMAND` 和 `ARG...` 会覆盖镜像默认的启动命令。

------------------------------------------------------------------------

### 别名

``` bash
Aliases: docker container run, docker run
```

**解释**：\
该命令的别名，`docker container run` 与 `docker run` 完全等效。

------------------------------------------------------------------------

### 选项解释

#### 1. 容器基础配置

``` bash
  -d, --detach                           后台运行容器并打印容器 ID
  --name string                          为容器指定名称
  --restart string                       容器退出时的重启策略（默认 "no"）
  --rm                                   容器退出后自动删除
  -it, --interactive --tty               以交互模式运行容器（分配伪终端）
```

**解释**：

-   `-d`：容器在后台运行（常用于服务类应用）。\
-   `--name`：为容器命名（如 `--name=web`），便于后续管理。\
-   `--restart`：设置重启策略（如 `--restart=always` 表示始终自动重启）。\
-   `--rm`：临时容器，退出后自动清理（适合一次性任务）。\
-   `-it`：交互模式运行容器（如进入容器终端操作）。

------------------------------------------------------------------------

#### 2. 资源限制

``` bash
  -m, --memory bytes                     内存限制（如 `-m 512m`）
  --cpus decimal                         CPU 核心数限制（如 `--cpus=1.5`）
  --shm-size bytes                       设置 `/dev/shm` 大小（如 `--shm-size=1g`）
  --ulimit ulimit                        资源限制（如 `--ulimit nofile=1024:1024`）
```

**解释**：

-   `-m`：限制容器最大内存使用量，避免资源耗尽。\
-   `--cpus`：限制容器使用的 CPU 核心数（支持小数，如 `1.5` 表示 1.5 个核心）。\
-   `--shm-size`：调整共享内存大小，解决某些应用（如数据库）的需求。\
-   `--ulimit`：限制进程资源（如文件句柄数、进程数）。

------------------------------------------------------------------------

#### 3. 网络与端口

``` bash
  -p, --publish list                     将容器端口映射到主机（格式: `主机端口:容器端口`）
  -P, --publish-all                      将所有暴露的端口映射到主机随机端口
  --network string                       指定容器网络模式（如 `host`、`bridge`）
  --add-host list                        添加自定义主机名到 IP 的映射（如 `--add-host=myhost:192.168.1.1`）
```

**解释**：

-   `-p`：端口映射（如 `-p 8080:80` 将容器 80 端口映射到主机的 8080 端口）。\
-   `-P`：自动映射所有 `EXPOSE` 声明的端口到主机随机端口。\
-   `--network`：指定网络模式（`host` 表示共享主机网络，`bridge` 为默认桥接模式）。\
-   `--add-host`：修改容器内的 `/etc/hosts` 文件（用于自定义域名解析）。

------------------------------------------------------------------------

#### 4. 卷与文件系统

``` bash
  -v, --volume list                      挂载卷（格式: `主机路径:容器路径[:选项]`）
  --mount mount                          更灵活的挂载方式（支持类型参数，如 `type=bind`）
  --read-only                            以只读模式挂载容器的根文件系统
  --tmpfs list                           挂载临时文件系统（如 `--tmpfs /tmp:size=100m`）
```

**解释**：

-   `-v`：挂载主机目录或卷到容器（如 `-v /data:/app/data`）。\
-   `--mount`：支持更复杂的挂载配置（如指定卷类型、只读选项）。\
-   `--read-only`：增强安全性，防止容器修改文件系统。\
-   `--tmpfs`：在内存中挂载临时目录（速度快，容器退出后数据丢失）。

------------------------------------------------------------------------

#### 5. 环境变量与配置

``` bash
  -e, --env list                         设置环境变量（如 `-e MY_ENV=value`）
  --env-file list                        从文件读取环境变量（每行一个 `KEY=VALUE`）
  --entrypoint string                    覆盖镜像的默认入口命令
  -w, --workdir string                   设置容器内的工作目录
```

**解释**：

-   `-e`：传递环境变量（如数据库密码）。\
-   `--env-file`：从文件批量加载环境变量（避免命令行暴露敏感信息）。\
-   `--entrypoint`：覆盖镜像的默认启动命令（如 `--entrypoint /bin/bash`）。\
-   `-w`：指定容器启动后的工作目录（如 `-w /app`）。

------------------------------------------------------------------------

#### 6. 安全与权限

``` bash
  --cap-add list                         添加 Linux 能力（如 `--cap-add=NET_ADMIN`）
  --cap-drop list                        移除 Linux 能力（如 `--cap-drop=CHOWN`）
  --privileged                           赋予容器特权模式（谨慎使用）
  --security-opt list                    安全选项（如 `--security-opt=seccomp=unconfined`）
```

**解释**：

-   `--cap-add`/`--cap-drop`：细粒度控制容器的权限（遵循最小权限原则）。\
-   `--privileged`：容器获得几乎全部主机权限（仅用于特殊场景，如调试内核模块）。\
-   `--security-opt`：调整安全策略（如禁用 seccomp 或 AppArmor）。

------------------------------------------------------------------------

#### 7. 日志与调试

``` bash
  --log-driver string                    指定日志驱动（如 `json-file`、`syslog`）
  --log-opt list                         日志驱动的配置选项（如 `--log-opt max-size=10m`）
  --cidfile string                       将容器 ID 写入文件（便于脚本处理）
```

**解释**：

-   `--log-driver`：选择日志存储方式（默认 `json-file`）。\
-   `--log-opt`：配置日志参数（如限制日志文件大小）。\
-   `--cidfile`：将容器 ID 保存到文件（如 `--cidfile=/tmp/container.id`）。

------------------------------------------------------------------------

### 示例用法

1.  **启动后台服务**：

    ``` bash
    docker run -d --name=nginx -p 80:80 nginx:latest
    ```

2.  **交互式调试容器**：

    ``` bash
    docker run -it --rm ubuntu:22.04 /bin/bash
    ```

3.  **挂载卷并传递环境变量**：

    ``` bash
    docker run -v /host/data:/app/data -e DB_PASSWORD=secret myapp:v1
    ```

------------------------------------------------------------------------

### **`docker run -it` 和 `docker run -d` 是互斥的，不能联用**

------------------------------------------------------------------------

### 1. **参数设计冲突**

-   **`-it`**：组合了 `-i`（保持 STDIN 打开）和 `-t`（分配伪终端），用于**交互式前台运行容器**（如进入容器终端操作）。
-   **`-d`**：让容器在**后台运行**（守护进程模式），与前台交互模式冲突。

------------------------------------------------------------------------

### 2. **行为矛盾**

-   若尝试联用（如 `docker run -itd`）：
    -   Docker 会优先执行 `-d`，将容器放入后台。

    -   但 `-it` 需要前台交互，此时容器会因无输入源而**立即退出**（除非有常驻进程）。

    -   示例：

        ``` bash
        docker run -itd ubuntu:22.04
        ```

        容器启动后会直接退出，需通过 `docker logs` 查看日志，或附加到容器：

        ``` bash
        docker attach <容器ID>  # 但后台容器通常无交互进程，可能无法操作
        ```

------------------------------------------------------------------------

### 3. **替代方案**

若需**后台运行容器并保留交互能力**，可通过以下方式实现：

-   **启动后台容器，并通过 `exec` 进入**：

    ``` bash
    # 1. 后台启动容器
    docker run -d --name=mycontainer ubuntu:22.04 tail -f /dev/null

    # 2. 进入容器终端
    docker exec -it mycontainer /bin/bash
    ```

-   **直接前台启动容器**（不推荐，会占用终端）：

    ``` bash
    docker run -it ubuntu:22.04 /bin/bash
    ```

------------------------------------------------------------------------

### 总结

-   **互斥性**：`-it` 和 `-d` 不能同时生效，联用会导致容器无法正常交互。
-   **正确用法**：根据需求选择：
    -   调试/交互：用 `-it`（前台）。
    -   服务部署：用 `-d`（后台）。

------------------------------------------------------------------------

### `docker run -d --name=mycontainer ubuntu:22.04 tail -f /dev/null`

------------------------------------------------------------------------

### 1. **命令结构**

``` bash
docker run -d --name=mycontainer ubuntu:22.04 tail -f /dev/null
```

-   **`docker run`**：Docker 核心命令，用于创建并启动一个新容器。
-   **`-d`**：后台运行容器（detached 模式）。
-   **`--name=mycontainer`**：为容器指定名称 `mycontainer`。
-   **`ubuntu:22.04`**：使用官方 Ubuntu 22.04 镜像作为容器的基础环境。
-   **`tail -f /dev/null`**：容器启动后执行的命令。

------------------------------------------------------------------------

### 2. **关键参数解析**

#### (1) `-d`（后台运行）

-   **作用**：容器在后台运行，不占用当前终端。
-   **典型场景**：部署服务或需要长期运行的容器。

#### (2) `--name=mycontainer`

-   **作用**：为容器命名，便于后续管理（如 `docker stop mycontainer`）。
-   **默认行为**：若未指定名称，Docker 会随机生成一个名称（如 `funny_panda`）。

#### (3) `ubuntu:22.04`

-   **作用**：指定容器的基础镜像。
-   **默认行为**：若本地无此镜像，Docker 会从镜像仓库（如 Docker Hub）自动拉取。

#### (4) `tail -f /dev/null`

-   **作用**：保持容器持续运行。
    -   `tail -f`：持续跟踪文件变化并输出内容。
    -   `/dev/null`：Linux 特殊设备文件，读取时立即返回 EOF（文件结束符）。
    -   **实际效果**：`tail -f /dev/null` 会无限阻塞，使容器不会退出。

------------------------------------------------------------------------

### 3. **为什么需要 `tail -f /dev/null`？**

-   **Ubuntu 镜像的默认行为**：\
    若直接运行 `docker run -d ubuntu:22.04`，容器会立即退出。\
    因为 Ubuntu 镜像的默认命令是 `/bin/bash`，而 `-d` 模式下没有交互输入，导致 Bash 直接退出。

-   **解决方案**：\
    通过 `tail -f /dev/null` 启动一个无实际作用但永不退出的进程，使容器保持运行状态。

------------------------------------------------------------------------

### 4. **典型使用场景**

#### 场景：启动一个后台容器，稍后进入交互终端

1.  **启动容器**：

    ``` bash
    docker run -d --name=mycontainer ubuntu:22.04 tail -f /dev/null
    ```

2.  **进入容器终端**：

    ``` bash
    docker exec -it mycontainer /bin/bash
    ```

    -   此时可在容器内执行任意命令（如安装软件、调试等）。

3.  **停止并清理容器**：

    ``` bash
    docker stop mycontainer && docker rm mycontainer
    ```

------------------------------------------------------------------------

### 5. **类比其他保持容器运行的命令**

-   `sleep infinity`：

    ``` bash
    docker run -d --name=mycontainer ubuntu:22.04 sleep infinity
    ```

-   `while true; do sleep 1; done`：

    ``` bash
    docker run -d --name=mycontainer ubuntu:22.04 sh -c "while true; do sleep 1; done"
    ```

-   **共同点**：通过无限循环或阻塞命令保持容器运行。

------------------------------------------------------------------------

### 6. **注意事项**

-   **资源占用**：`tail -f /dev/null` 几乎不占用 CPU 和内存。
-   **替代方案**：若需容器执行实际任务（如 Web 服务），应替换为具体命令（如 `nginx -g 'daemon off;'`）。
-   **容器生命周期**：需手动停止和删除容器（除非使用 `--rm` 参数）。

------------------------------------------------------------------------
