---
editor_options: 
  markdown: 
    wrap: 72
---

# 使用 MTR 工具进行网络链路分析

## 测试流程

``` mermaid
flowchart LR
    A[开始] --> B[获取本地网络的公网IP]
    B --> C[正向链路测试（ping和mtr）客户端->目标服务器]
    C --> D[反向链路测试（ping和mtr）目标服务器->客户端]
    D --> E[测试结果分析]
    E --> F[结束]
```

## 工具安装

### Linux 系统

``` bash
sudo apt install mtr  # Debian/Ubuntu
sudo yum install mtr  # CentOS/RHEL
```

### Windows 系统

推荐使用 [WinMTR](https://sourceforge.net/projects/winmtr/)

------------------------------------------------------------------------

## 基础命令格式

``` bash
mtr [options] hostname/ip
```

### 常用参数说明

| 参数      | 说明                 |
|-----------|----------------------|
| `-r`      | 报告模式（非交互式） |
| `-n`      | 禁用 DNS 反向解析    |
| `-c 50`   | 设置发送数据包数量   |
| `-i 0.5`  | 设置探测间隔（秒）   |
| `-4`/`-6` | 强制使用 IPv4/IPv6   |

------------------------------------------------------------------------

## 高级诊断模式

### TCP 模式（绕过 ICMP 限制）

``` bash
sudo mtr -T -P 443 www.example.com  # 模拟 HTTPS 流量
```

### UDP 模式

``` bash
sudo mtr -u -P 53 8.8.8.8  # 模拟 DNS 流量
```

------------------------------------------------------------------------

## 结果解读指南

### 输出字段说明

| 字段  | 说明               |
|-------|--------------------|
| Host  | 节点 IP/域名       |
| Loss% | 丢包率             |
| Snt   | 已发送数据包数     |
| Last  | 最近一次延迟（ms） |
| Avg   | 平均延迟（ms）     |
| Best  | 最低延迟（ms）     |
| Wrst  | 最高延迟（ms）     |
| StDev | 延迟波动           |

------------------------------------------------------------------------

## 网络区域分析

### 典型网络拓扑

``` mermaid
graph LR
  A[客户端本地网络] --> B[运营商网络]
  B --> C[目标服务器网络]
```

### 异常定位策略

1.  **本地网络异常**（前 1-3 跳）

    -   检查本地路由器和防火墙设置
    -   重启网络设备测试

2.  **运营商网络异常**（中间跳数）

    -   记录异常节点 IP
    -   使用 `whois` 查询归属运营商

    ``` bash
    whois 202.96.128.86
    ```

3.  **目标网络异常**（最后 3-5 跳）

    -   检查目标服务器安全组规则
    -   验证目标服务端口状态

    ``` bash
    telnet example.com 443
    ```

------------------------------------------------------------------------

## 常见问题诊断

### 场景 1：目标主机 100% 丢包

``` text
Host        Loss%  Snt  Last  Avg  Best  Wrst  StDev
8.8.8.8     100%    50   --    --    --    --    0.0
```

**可能原因**： - 目标服务器防火墙阻止 ICMP - 运营商策略限制

**解决方案**： 1. 使用 TCP 模式验证 2. 检查目标服务器安全策略

### 场景 2：中间节点高延迟

``` text
Host        Loss%  Snt  Last  Avg  Best  Wrst  StDev
4. 202.97.50.142  0.0%   50  32.1  28.3  25.6  189.2  18.7
```

**分析要点**： - 观察后续节点是否恢复 - 检查 StDev 值判断波动性 -
结合反向链路测试验证

### 场景 3：路由环路

``` text
Host        Loss%  Snt  Last  Avg  Best  Wrst  StDev
5. 61.152.24.101   0.0%   50   25.3  26.1  24.8  32.9   1.2
6. 202.97.90.206   0.0%   50   26.5  27.3  25.1  35.2   2.1
7. 61.152.24.101   0.0%   50   25.8  26.7  24.9  33.8   1.5
```

**特征**： - IP 地址重复出现 - TTL 值循环变化

**处理建议**： 1. 记录完整环路路径 2. 向相关运营商提交工单

------------------------------------------------------------------------

## 高级分析技巧

### 数据包大小测试

``` bash
mtr -s 1024 -r example.com  # 测试大包传输
```

### 多协议对比

``` bash
# ICMP 测试
mtr -r example.com > result_icmp.txt

# TCP 测试
mtr -T -P 443 -r example.com > result_tcp.txt

# 结果对比
diff result_icmp.txt result_tcp.txt
```

------------------------------------------------------------------------

## 注意事项

1.  **权限要求**：TCP/UDP 模式需要 `sudo` 权限
2.  **结果差异**：不同协议路径可能不同
3.  **数据时效**：建议测试 50-100 个数据包
4.  **跨境测试**：使用 `--report-wide` 显示完整信息
5.  **文档参考**：访问[阿里云 MTR
    文档](https://www.alibabacloud.com/help/doc-detail/40573.htm)

> 最后更新：2025-02-11 \| 文档版本：2.1.3
