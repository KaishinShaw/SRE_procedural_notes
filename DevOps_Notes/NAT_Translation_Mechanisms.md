# NAT（网络地址转换）技术简介

## 目录

1.  [基本概念与定义](#基本概念与定义)
2.  [NAT转换表结构](#nat转换表结构)
3.  [NAT工作模式](#nat工作模式)
4.  [S/D地址转换机制](#sd地址转换机制)
5.  [实际通信场景分析](#实际通信场景分析)
6.  [动态NAT端口冲突处理](#动态nat端口冲突处理)
7.  [技术总结](#技术总结)

------------------------------------------------------------------------

## 基本概念与定义 {#基本概念与定义}

### 1. 主机专用IP地址（私有IP）

**定义**：

-   用于内部网络的非全局唯一地址
-   遵循RFC私有地址标准：
    -   **IPv4**：
        -   10.0.0.0/8
        -   172.16.0.0/12
        -   192.168.0.0/16
    -   **IPv6**：
        -   fd00::/8（ULA地址）

**特性**：

-   仅限内部网络通信
-   不可直接路由到互联网
-   示例：`192.168.1.100`

### 2. 转换后的IP地址（公有IP）

**定义**：

-   全局唯一的互联网可路由地址
-   来源：
    -   ISP分配（家庭宽带）
    -   企业/云服务商分配（服务器集群）

**特性**：

-   隐藏内部网络结构
-   支持地址复用
-   示例：`203.0.113.5`

------------------------------------------------------------------------

## NAT转换表结构 {#nat转换表结构}

### 核心字段说明

| 字段名称        | 描述                | 示例值        |
|-----------------|---------------------|---------------|
| 内部源IP        | 内网设备私有IP      | 192.168.1.100 |
| 内部源端口      | 内网设备源端口      | 5000          |
| 外部映射IP      | 转换后的公网IP      | 203.0.113.5   |
| 外部映射端口    | 转换后的公网端口    | 54321         |
| 协议类型        | 通信协议（TCP/UDP） | TCP           |
| 存活时间（TTL） | 条目有效期（秒）    | 300           |

### 典型条目示例

``` plaintext
192.168.1.100:5000 → 203.0.113.5:54321, TCP, TTL=300s
```

------------------------------------------------------------------------

## NAT工作模式 {#nat工作模式}

### 1. 静态NAT（1:1映射）

| 特性     | 说明                        |
|----------|-----------------------------|
| 映射方式 | 固定IP一对一映射            |
| 端口使用 | 完全复用                    |
| 典型应用 | 服务器对外发布              |
| 示例     | 192.168.1.10 ↔ 203.0.113.10 |

### 2. 动态NAT（PAT）

| 特性     | 说明                  |
|----------|-----------------------|
| 映射方式 | 多对一端口复用        |
| 端口使用 | 动态分配              |
| 典型应用 | 家庭网络共享上网      |
| 示例     | 多设备共享203.0.113.5 |

------------------------------------------------------------------------

## S/D地址转换机制 {#sd地址转换机制}

### 流量方向与转换类型

| 流量方向 | 转换类型 | 转换地址    | 保持不变的地址 |
|----------|----------|-------------|----------------|
| 出站     | SNAT     | 源地址(S)   | 目标地址(D)    |
| 入站     | DNAT     | 目标地址(D) | 源地址(S)      |

### 转换表示例对比

#### 出站流量（SNAT）

| 方向    | 原始地址           | 转换后地址        |
|---------|--------------------|-------------------|
| 源(S)   | 192.168.1.100:5000 | 203.0.113.5:54321 |
| 目标(D) | 93.184.216.34:80   | 93.184.216.34:80  |

#### 入站流量（DNAT）

| 方向    | 原始地址            | 转换后地址          |
|---------|---------------------|---------------------|
| 目标(D) | 203.0.113.5:80      | 192.168.1.2:80      |
| 源(S)   | 121.202.45.67:12345 | 121.202.45.67:12345 |

------------------------------------------------------------------------

## 实际通信场景分析 {#实际通信场景分析}

### 网页访问流程

1.  **出站请求（SNAT）**

    ``` mermaid
    sequenceDiagram
        内网设备->>NAT设备: 请求[192.168.1.100:5000 → 93.184.216.34:80]
        NAT设备->>外网服务器: 转换后请求[203.0.113.5:54321 → 93.184.216.34:80]
    ```

2.  **入站响应（反向映射）**

    ``` mermaid
    sequenceDiagram
        外网服务器->>NAT设备: 响应[93.184.216.34:80 → 203.0.113.5:54321]
        NAT设备->>内网设备: 转换后响应[93.184.216.34:80 → 192.168.1.100:5000]
    ```

### 端口复用机制

``` plaintext
设备A：192.168.1.100:5000 → 203.0.113.5:54321
设备B：192.168.1.101:5000 → 203.0.113.5:54322
```

------------------------------------------------------------------------

## 动态NAT端口冲突处理 {#动态nat端口冲突处理}

### 冲突解决机制

1.  **五元组唯一性保证**

    ``` plaintext
    (源IP, 源端口, 协议, 目标IP, 目标端口)
    ```

2.  **端口分配策略**

    | 设备 | 内部地址           | 外部映射          |
    |------|--------------------|-------------------|
    | PC1  | 192.168.1.100:5000 | 203.0.113.5:54321 |
    | PC2  | 192.168.1.101:5000 | 203.0.113.5:54322 |

### 映射表示例

| 内部IP:端口        | 外部IP:端口       | 目标地址          | 协议 | TTL |
|--------------------|-------------------|-------------------|------|-----|
| 192.168.1.100:5000 | 203.0.113.5:54321 | 172.217.14.206:80 | TCP  | 300 |
| 192.168.1.101:5000 | 203.0.113.5:54322 | 172.217.14.206:80 | TCP  | 300 |

------------------------------------------------------------------------

## 技术总结 {#技术总结}

### 核心优势

1.  **地址复用**：多设备共享公网IP
2.  **安全增强**：隐藏内部网络拓扑
3.  **灵活扩展**：支持端口重定向

### 工作机制对比

| 类型 | 转换方向 | 典型应用           | 条目特性      |
|------|----------|--------------------|---------------|
| SNAT | 出站     | 内网设备访问互联网 | 动态生成/短期 |
| DNAT | 入站     | 外网访问内网服务   | 静态配置/长期 |

### 关键技术指标

1.  **端口容量**：单IP支持约65,535个并发连接
2.  **映射效率**：μs级转换延迟
3.  **安全特性**：状态化防火墙功能集成
