# DHCP 协议详解

## 1. DHCP 概述

**DHCP**（Dynamic Host Configuration Protocol，动态主机配置协议）是一种网络协议，用于自动为设备分配IP地址及网络配置参数（包括子网掩码、默认网关、DNS服务器等）。

### 核心特性

-   **自动化管理**：消除手动配置需求
-   **动态分配**：IP地址按需分配与回收
-   **参数整合**：集中管理所有网络配置
-   **租约机制**：设定IP地址有效期

## 2. 工作原理与交互流程（DORA模型）

### 场景示例

公司员工连接Wi-Fi时自动获取网络配置：

``` markdown
IP地址：192.168.1.100
子网掩码：255.255.255.0
默认网关：192.168.1.1
DNS服务器：8.8.8.8
```

### 四步交互过程

| 阶段 | 报文类型      | 方向          | 说明                                  |
|------|---------------|---------------|---------------------------------------|
| 1    | DHCP Discover | 客户端→广播   | 寻找可用DHCP服务器                    |
| 2    | DHCP Offer    | 服务器→客户端 | 提供IP地址及配置参数（可能单播/广播） |
| 3    | DHCP Request  | 客户端→广播   | 确认接受特定服务器的Offer             |
| 4    | DHCP ACK      | 服务器→客户端 | 正式分配IP地址（可能单播/广播）       |

#### 详细流程

1.  **发现阶段（Discover）**
    -   客户端广播发送`DHCPDISCOVER`报文（目标IP 255.255.255.255）
    -   携带事务ID（XID）用于会话跟踪
2.  **提供阶段（Offer）**
    -   服务器从地址池选择可用IP

    -   包含关键参数：租期、子网掩码、网关、DNS

    -   示例Offer内容：

        ``` yaml
        Offered IP: 192.168.1.100/24
        Lease Time: 86400s
        Gateway: 192.168.1.1 
        DNS: 8.8.8.8
        ```
3.  **请求阶段（Request）**
    -   客户端可能收到多个Offer，但只选择一个
    -   广播通知所有服务器选择的配置
4.  **确认阶段（Acknowledge）**
    -   服务器锁定IP地址分配
    -   客户端启动租期计时器（T1=50%, T2=87.5%）

## 3. DHCP 报文解析

### 报文类型总览

| 类型          | 代码 | 说明                     |
|---------------|------|--------------------------|
| DHCP Discover | 1    | 客户端初始化请求         |
| DHCP Offer    | 2    | 服务器配置提供           |
| DHCP Request  | 3    | 客户端配置确认请求       |
| DHCP ACK      | 5    | 服务器最终确认           |
| DHCP NAK      | 6    | 服务器拒绝请求           |
| DHCP Release  | 7    | 客户端主动释放IP         |
| DHCP Inform   | 8    | 客户端已有IP请求额外配置 |

### 报文结构

``` markdown
+-----------------------+
| OP (1)               | → 操作码（1=请求，2=响应）
+-----------------------+
| HTYPE (1)            | → 硬件类型（1=以太网）
+-----------------------+
| HLEN (1)             | → MAC地址长度（6）
+-----------------------+
| HOPS (1)             | → 中继跳数
+-----------------------+
| Transaction ID (4)   | → 会话标识符
+-----------------------+
| Seconds (2)          | → 客户端启动时间
+-----------------------+
| Flags (2)            | → 广播/单播标志
+-----------------------+
| Client IP (4)        | → 客户端当前IP（非必须）
+-----------------------+
| Your IP (4)          | → 分配IP地址
+-----------------------+
| Server IP (4)        | → 服务器标识
+-----------------------+
| Gateway IP (4)       | → 中继代理地址
+-----------------------+
| Client MAC (16)      | → 客户端物理地址
+-----------------------+
| Server Name (64)     | → 服务器名称（可选）
+-----------------------+
| Boot File (128)      | → 引导文件（PXE用）
+-----------------------+
| Options (var)        | → 核心配置参数区
+-----------------------+
```

### 关键选项字段（Options）

| 代码 | 名称              | 值示例              |
|------|-------------------|---------------------|
| 1    | Subnet Mask       | 255.255.255.0       |
| 3    | Router            | 192.168.1.1         |
| 6    | DNS Servers       | 8.8.8.8, 8.8.4.4    |
| 51   | Lease Time        | 86400 (24小时)      |
| 53   | DHCP Message Type | 1-8对应不同报文类型 |
| 54   | Server Identifier | 192.168.1.253       |

## 4. 高级特性

### 地址租约管理

-   **租约更新流程**：
    1.  T1时间（租期50%）发送单播DHCP Request
    2.  成功收到ACK则续约
    3.  T2时间（租期87.5%）转为广播请求
    4.  租期到期释放地址
-   **租约数据库示例**：

``` sql
IP地址       MAC地址          租期到期时间
192.168.1.100 00:1A:3F:AE:45:12 2023-10-01 14:30:00
192.168.1.101 08:00:27:AB:CD:EF 2023-10-01 15:45:00
```

### 安全机制

-   **DHCP Snooping**：
    -   交换机端口信任分级
    -   过滤非法服务器报文
    -   绑定表维护（IP+MAC+Port）
-   **其他措施**：
    -   动态ARP检测（DAI）
    -   IP Source Guard

## 5. 应用场景对比

| 场景类型     | 配置方式 | IP稳定性 | 管理复杂度 | 典型应用            |
|--------------|----------|----------|------------|---------------------|
| 动态分配     | DHCP自动 | 低       | 低         | 员工设备/移动终端   |
| 静态保留     | DHCP绑定 | 高       | 中         | 打印机/摄像头       |
| 完全手动配置 | 人工设置 | 最高     | 高         | 核心服务器/网络设备 |

## 6. 故障排查指南

### 常见问题诊断

1.  **地址耗尽**：
    -   现象：客户端无法获取IP
    -   检查：地址池使用率，租期设置
2.  **配置冲突**：
    -   现象：IP地址冲突警告
    -   检查：静态分配记录，排除地址重叠
3.  **中继故障**：
    -   现象：跨网段分配失败
    -   检查：中继代理配置，路由可达性

### 抓包分析示例

``` wireshark
No. Time    Source        Destination   Protocol Info
1   0.000   0.0.0.0       255.255.255.255 DHCP     DHCP Discover
2   0.050   192.168.1.253 255.255.255.255 DHCP     DHCP Offer
3   0.100   0.0.0.0       255.255.255.255 DHCP     DHCP Request
4   0.150   192.168.1.253 192.168.1.100   DHCP     DHCP ACK
```

## 7. 扩展知识

### IPv6 DHCPv6 差异

-   使用UDP 546/547端口（vs IPv4 67/68）
-   无广播通信（使用组播地址FF02::1:2）
-   两种模式：
    -   无状态模式（SLAAC）
    -   有状态模式（DHCPv6）

### 云环境适配

-   **SDN集成**：动态地址池与租户网络绑定
-   **弹性扩展**：根据负载自动调整地址池大小
-   **安全组联动**：IP分配触发安全策略应用
